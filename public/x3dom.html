<html> 
    <head> 
        <title>My first X3DOM page</title> 	
        <script src='javascripts/jquery-1.11.3.js'></script>
        <script src='javascripts/x3dom.js'></script>
        <script src='javascripts/nebula-client.js'></script>
        <script src="/socket.io/socket.io.js"></script>
        <link rel='stylesheet' type='text/css' href='stylesheets/x3dom.css'></link> 
        <style>
            .selected
            {
                border: 2pt;
                border-color: orange;
            }
            x3d
            {
                //border:2px solid darkorange;        
                background-color: black;
                width: 100%;
                height: 100%;
                border: 0;
                margin: 0;
                padding: 0;
            }       
            body
            {     
                background-color: black;
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
            }

            h1
            {
                color: darkorange;
            }             

            #tools
            {
                top:0;
                left:0;
                margin:0;
                padding:0;
                position:absolute;
                display:inline;
                z-index:100;
            }
            #tools li
            {
                line-height:0px;
                list-style-type:none;
                display:inline;
                padding:0;
                margin:0 -4px 0 0;
                float:left;
            }
            #tools li button
            {
                border:1px solid #666;
                background-color:#202021;
                color:#ccc;
                padding:4px;
                margin:0;
                display:inline;
                margin-top:-1px;
            }
            #tools li:first-child button
            {
                margin-left:-1px;
            }
            #tools li button:hover
            {
                background-color:blue;
            }
            #tools li input
            {
                border:1px solid #666;
                background-color:#202021;
                color:#ccc;
                padding:4px;
                margin:0;
                display:linline;
                margin-top:-1px;
            }
        </style>
    </head> 
    <body onkeydown="//console.log(event);">

    <x3d id="boxes" keysEnabled="True">
        <ul id="tools">
            <li><button onclick="mds();">MDS</button></li>
            <li><button onclick="invmds();">Inverse MDS</button></li>
            <li>
                <input type="text" id="query" onkeydown="query(event);">
            </li>
        </ul>

        <template id="datum_template">
            <Group id="group">
                <Transform id="transform">
                    <Transform>
                        <PlaneSensor id="sensor" autoOffset="true"></PlaneSensor>
                        <Switch id="type_switch" whichChoice="0">
                            <transform scale="1.5 1.5 1">
                                <Switch class="style_switch" whichChoice="0">
                                    <shape>
                                        <appearance>
                                            <material diffuseColor='1 0 0'></material>
                                        </appearance>
                                        <Sphere></Sphere>
                                    </shape>
                                    <shape>
                                        <appearance>
                                            <material diffuseColor='0 1 0'></material>
                                        </appearance>
                                        <Sphere></Sphere>
                                    </shape>
                                    <shape>
                                        <appearance>
                                            <material diffuseColor='0 0 1'></material>
                                        </appearance>
                                        <Sphere></Sphere>
                                    </shape>
                                </Switch>
                            </transform>
                            <transform class="image_scale" scale="1 1 1">
                                <shape>
                                    <appearance>
                                        <material DEF='Red' diffuseColor='1 0 0'></material>
                                        <imageTexture id="image"></imageTexture>
                                    </appearance>
                                    <box size='30 30 1'></box>
                                </shape>
                            </transform>
                        </Switch>
                    </Transform>
                    <billboard axisOfRotation="0 0 0">
                        <transform scale="4 4 1" translation='0 -6 0.64087'>
                            <Switch class="style_switch" whichChoice="0">
                                <shape>
                                    <appearance>
                                        <material diffuseColor='1 1 1'></material>
                                    </appearance>
                                    <text class="datum_label" string='"I am a Label ID"'>
                                    <fontStyle family='"SAN"' justify='"MIDDLE" "BEGIN"'></fontStyle>
                                    </text>
                                </shape>
                                <shape>
                                    <appearance>
                                        <material diffuseColor='0 1 0'></material>
                                    </appearance>
                                    <text class="datum_label" string='"I am a Label ID"'>
                                    <fontStyle family='"SAN"' justify='"MIDDLE" "BEGIN"'></fontStyle>
                                    </text>
                                </shape>
                            </Switch>
                        </transform>
                    </billboard>
                </Transform>
                <PositionInterpolator id="pi" key="0 1"></PositionInterpolator>
                <Route id="timer_route" fromField="fraction_changed" toField="set_fraction"></Route>
                <Route id="pi_route" fromField="value_changed" toField="translation"></Route>
            </Group>
        </template>

        <scene id="scene">
            <navigationInfo type="None"></navigationInfo>
            <orthoViewpoint fieldOfView='-60 -60 60 60'></orthoviewpoint>
            <transform id="root" translation="0 0 0">

            </transform> 

            <timeSensor id="timer" onoutputchange="handleTimer(event);"></timesensor>
        </scene>
    </x3d>

    <script type="text/javascript">
                var nextId = 0;
                var points = new NEBULA.DatumSet();
                var jobId;
                var width, height;
                var socket;
                
                $(function() {
                    width = 60;
                    height = 60;

                  socket = io.connect();
			      socket.on('action', function(data) {
			    	  if (data.type == "move") {
			        	  position = (data.pos[0] * width) + " " + (data.pos[1] * height) + " 0";
			        	  points.get(data.pointId).setPosition(position);
			          }
			          else if (data.type == "select") {
			        	  points.get(data.pointId).select(data.state);
			          }
			      });
			      
			      socket.on('update', function(data) {
			    	  update(data);
			      });
			      
			      socket.emit('join', 'default', socket.id);
                   
                });
                
                function normalizePos(pos) {
                	var newPos = [];
                	newPos.push(pos.x / width);
                	newPos.push(pos.y / height);
                	return newPos;
                }
                	
                function viewChanged(event)
                {
                    console.log(event);
                }
                
                function handleTimer(event)
                {
                    if (event.fieldName === "isActive" && event.value === false) {
                    	for (var id of points.keys()) {
                            pos = points.get(id).getInterpolatedPosition();
                            points.get(id).setPosition(pos);
                        }
                    }
                }
                
                function handleEvent(event)
                {
                    if (event.type === "outputchange" && event.fieldName === "translation_changed") {
                    	console.log(event.value);
                    	datum = points.find(event.target);
                    	pos = event.value.x + " " + event.value.y + " 0";
                        datum.transform.setAttribute("translation", pos);
                        socket.emit("action", {type: "move", pointId: datum.getId(), pos: normalizePos(event.value)})
                    }
                    else if (event.type === "click") {
                        datum = points.find(event.target);
                        datum.toggleSelect();
                        socket.emit("action", {pointId: datum.getId(), type: "select", state: datum.selected()});
                    }
                }

                function mds()
                {
                	console.log("Emitting none update");
                	socket.emit('update', {type: "none"});
                }

                function invmds()
                {
                    if ($("#timer").prop("isActive")) {
                        return;
                    }
                    socket.emit('update', {type: "oli"});
                    //socket.emit('update', {type: "invmds"});
                }
                
                function query(event)
                {
                	if (event.keyCode == 13) {
                		socket.emit('update', {type: "search", query: event.target.value})
                		event.target.value = "";
                	}
                	
                }

                function update(interfaceUpdate) {
                    console.log(interfaceUpdate);

                    var animate = false;
                    if (interfaceUpdate.points) {
	                    for (var i = 0; i < interfaceUpdate.points.length; i++) {
	                        point = interfaceUpdate.points[i];
	                        id = point.id;
	                        pos = {};
	                        pos.x = point.pos[0] * width;
	                        pos.y = point.pos[1] * height;
	                        pos.z = 0;
	                        var selected = false;
	                        if (point.selected) {
	                        	selected = point.selected;
	                        }
	                        if (points.has(id)) {
	                        	p = points.get(id);
	                            curPos = p.getPosition();
	                            newPos = pos.x + " " + pos.y + " " + pos.z;
	                            p.setInterpolatorPositions(curPos + " " + newPos);
	                            animate = true;
	                            
	                            if (point.relevance) {
	                            	console.log("Setting relevance");
	                            	scale = 0.5 + point.relevance;
	                            	p.setScale(scale + "," + scale + "," + 1);
	                            }
	                            //points.get(id).select(selected);
	                        }
	                        else {
	                        	label = point.label || point.id;
	                            root = document.getElementById("root");
	                            var datum = new NEBULA.Datum(root, id, label, handleEvent);
	                            curPos = pos.x + " " + pos.y + " " + pos.z;
	                            datum.setPosition(curPos);
	                            datum.setInterpolatorPositions(curPos + " " + curPos);
	                            datum.select(selected);
	                            points.add(datum);
	                            
	                            if (point.relevance) {
	                            	console.log("Setting new relevance");
	                            	scale = 0.5 + point.relevance;
	                            	datum.setScale(scale + "," + scale + "," + 1);
	                            }
	                        }
	                    }
                    }
                    if (interfaceUpdate.weights) {
                    	console.log(interfaceUpdate.weights);
                    }
                    if (animate) {
                        $("#timer").attr("startTime", Date.now() / 1000);
                    }
                }

    </script>
</body>
</html>